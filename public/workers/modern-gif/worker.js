var je=Object.defineProperty,Ge=Object.defineProperties,Qe=Object.getOwnPropertyDescriptors,Ce=Object.getOwnPropertySymbols,Je=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable,T=Math.pow,de=(e,t,r)=>t in e?je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,M=(e,t)=>{for(var r in t||(t={}))Je.call(t,r)&&de(e,r,t[r]);if(Ce)for(var r of Ce(t))Ye.call(t,r)&&de(e,r,t[r]);return e},R=(e,t)=>Ge(e,Qe(t)),x=(e,t,r)=>de(e,"symbol"!=typeof t?t+"":t,r),Z=(e,t,r)=>new Promise((i,n)=>{var o=e=>{try{a(r.next(e))}catch(e){n(e)}},l=e=>{try{a(r.throw(e))}catch(e){n(e)}},a=e=>e.done?i(e.value):Promise.resolve(e.value).then(o,l);a((r=r.apply(e,t)).next())});!function(){"use strict";let e;let t=["87a","89a"];function r(e){let t=new Uint8Array(e.reduce((e,t)=>e+t.byteLength,0));return e.reduce((e,r)=>(t.set(r,e),e+r.byteLength),0),t}function i(e,t,r){let i;if(ArrayBuffer.isView(e))i=e.buffer;else if(e instanceof ArrayBuffer)i=e;else{let t=document.createElement("canvas"),{width:n,height:o}=r||{},l=t.getContext("2d");if(!l)throw Error("Failed to create canvas context2d");t.width=null!=n?n:"width"in e?"number"==typeof e.width?e.width:e.width.baseVal.value:0,t.height=null!=o?o:"height"in e?"number"==typeof e.height?e.height:e.height.baseVal.value:0,l.drawImage(e,0,0,t.width,t.height),i=l.getImageData(0,0,t.width,t.height).data.buffer}switch(t){case"uint8Array":return new Uint8Array(i);case"uint8ClampedArray":return new Uint8ClampedArray(i);case"dataView":return new DataView(i);default:throw Error("Unsupported output format")}}class n{constructor(e){x(this,"_view"),x(this,"offset",0),this._view=i(e,"dataView")}readByte(){return this._view.getUint8(this.offset++)}readBytes(e){return Array.from({length:e}).map(()=>this.readByte())}readString(e){return String.fromCharCode(...this.readBytes(e))}readUnsigned(){return[this._view.getUint16(this.offset,!0),this.offset+=2][0]}readBits(){return this._view.getUint8(this.offset++).toString(2).padStart(8,"0").split("").map(Number)}readColorTable(e){return Array.from({length:e},()=>Array.from(this.readBytes(3)))}readSubBlock(){let e=[];for(;;){let t=this.readByte();if(0===t&&0!==this._view.getUint8(this.offset))break;e.push(t)}return e}}let o="u">typeof window,l=[0,20,40,60,80,99,119,139,159,179,199,219,241,264,288,313,340,367,396,427,458,491,526,562,599,637,677,718,761,805,851,898,947,997,1048,1101,1156,1212,1270,1330,1391,1453,1517,1583,1651,1720,1790,1863,1937,2013,2090,2170,2250,2333,2418,2504,2592,2681,2773,2866,2961,3058,3157,3258,3360,3464,3570,3678,3788,3900,4014,4129,4247,4366,4488,4611,4736,4864,4993,5124,5257,5392,5530,5669,5810,5953,6099,6246,6395,6547,6700,6856,7014,7174,7335,7500,7666,7834,8004,8177,8352,8528,8708,8889,9072,9258,9445,9635,9828,10022,10219,10417,10619,10822,11028,11235,11446,11658,11873,12090,12309,12530,12754,12980,13209,13440,13673,13909,14146,14387,14629,14874,15122,15371,15623,15878,16135,16394,16656,16920,17187,17456,17727,18001,18277,18556,18837,19121,19407,19696,19987,20281,20577,20876,21177,21481,21787,22096,22407,22721,23038,23357,23678,24002,24329,24658,24990,25325,25662,26001,26344,26688,27036,27386,27739,28094,28452,28813,29176,29542,29911,30282,30656,31033,31412,31794,32179,32567,32957,33350,33745,34143,34544,34948,35355,35764,36176,36591,37008,37429,37852,38278,38706,39138,39572,40009,40449,40891,41337,41785,42236,42690,43147,43606,44069,44534,45002,45473,45947,46423,46903,47385,47871,48359,48850,49344,49841,50341,50844,51349,51858,52369,52884,53401,53921,54445,54971,55500,56032,56567,57105,57646,58190,58737,59287,59840,60396,60955,61517,62082,62650,63221,63795,64372,64952,65535],a=[0,6,13,18,22,25,28,31,34,36,38,40,42,44,46,48,50,51,53,54,56,57,59,60,61,62,64,65,66,67,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,86,87,88,89,90,91,91,92,93,94,95,95,96,97,98,98,99,100,101,101,102,103,103,104,105,106,106,107,108,108,109,110,110,111,111,112,113,113,114,115,115,116,116,117,118,118,119,119,120,121,121,122,122,123,123,124,125,125,126,126,127,127,128,128,129,129,130,130,131,132,132,133,133,134,134,135,135,136,136,137,137,138,138,139,139,140,140,140,141,141,142,142,143,143,144,144,145,145,146,146,147,147,147,148,148,149,149,150,150,151,151,151,152,152,153,153,154,154,154,155,155,156,156,156,157,157,158,158,159,159,159,160,160,161,161,161,162,162,163,163,163,164,164,165,165,165,166,166,166,167,167,168,168,168,169,169,169,170,170,171,171,171,172,172,172,173,173,174,174,174,175,175,175,176,176,176,177,177,177,178,178,179,179,179,180,180,180,181,181,181,182,182,182,183,183,183,184,184,184,185,185,185,186,186,186,187,187,187,188,188,188,189,189,189,190,190,190,191,191,191,192,192,192,193,193,193,193,194,194,194,195,195,195,196,196,196,197,197,197,198,198,198,198,199,199,199,200,200,200,201,201,201,201,202,202,202,203,203,203,204,204,204,204,205,205,205,206,206,206,206,207,207,207,208,208,208,208,209,209,209,210,210,210,210,211,211,211,212,212,212,212,213,213,213,214,214,214,214,215,215,215,215,216,216,216,217,217,217,217,218,218,218,218,219,219,219,220,220,220,220,221,221,221,221,222,222,222,222,223,223,223,224,224,224,224,225,225,225,225,226,226,226,226,227,227,227,227,228,228,228,228,229,229,229,229,230,230,230,230,231,231,231,231,232,232,232,232,233,233,233,233,234,234,234,234,235,235,235,235,236,236,236,236,237,237,237,237,238,238,238,238,239,239,239,239,239,240,240,240,240,241,241,241,241,242,242,242,242,243,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,249,250,250,250,250,251,251,251,251,251,252,252,252,252,253,253,253,253,253,254,254,254,254,255,255,255];function s(e){let t;if(e<=0)return 0;if(e>=65535)return 65535;t=e*(e*(e+-144107)/65535+132114)/65535+14379;for(let r=0;r<2;r++){let r=t*t*t,i=e+(2*r+0xfffe0001/2)/0xfffe0001;t=(t*(2*e+(r+0xfffe0001/2)/0xfffe0001)+i/2)/i}return t}function h(e,t){return(e^t)<0?(e-t/2)/t:(e+t/2)/t}function c(e,t,r,i,n=!0,o=[255,255,255]){if(!n){let n=1-(i/=255);e=e*i+n*o[0]&255,t=t*i+n*o[1]&255,r=r*i+n*o[2]&255}return{r:e,g:t,b:r}}function d(e,t,r){return e<<16|t<<8|r}function u(e,t,r){let i=(27015*(e=l[e])+35149*(t=l[t])+3372*(r=l[r])+32767.5)/65535,n=(13887*e+44610*t+7038*r+32767.5)/65535,o=(5787*e+18462*t+41286*r+32767.5)/65535,a=s(i),c=s(n),d=s(o);return{l:h(13792*a+52010*c-267*d,65535),a:h(129628*a-159158*c+29530*d,65535),b:h(1698*a+51299*c-52997*d,65535)}}function f(e){if(e<=0)return 0;if(e>=65535)return 255;{let t=511*e,r=~~(t/65535),i=a[r];return(t%65535*(a[r+1]-i)+32767.5)/65535+i}}class g{constructor(){this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>Z(this,null,function*(){var t,r,i,n;let o;if("string"==typeof e){let t=yield new Promise(t=>{let r=new Image;r.decoding="sync",r.loading="eager",r.crossOrigin="anonymous",r.onload=()=>t(r),r.onerror=()=>t(r),r.src=e}),r=g.ctx2d,i=r.canvas;r.clearRect(0,0,i.width,i.height),i.width=t.width,i.height=t.height,r.drawImage(t,0,0,i.width,i.height),o=r.getImageData(0,0,i.width,i.height).data}else if(ArrayBuffer.isView(e))o=new Uint8ClampedArray(e.buffer);else if(e instanceof ArrayBuffer)o=new Uint8ClampedArray(e);else if(Array.isArray(e)){if(Array.isArray(e[0])){let l=[];for(let o=e.length,a=0;a<o;a++)l.push(null!=(t=e[a][0])?t:0,null!=(r=e[a][1])?r:0,null!=(i=e[a][2])?i:0,null!=(n=e[a][3])?n:255);o=new Uint8ClampedArray(l)}else o=new Uint8ClampedArray(e)}else{let t=g.ctx2d,r=t.canvas;t.clearRect(0,0,r.width,r.height),r.width="number"==typeof e.width?e.width:e.width.baseVal.value,r.height="number"==typeof e.height?e.height:e.height.baseVal.value,t.drawImage(e,0,0,r.width,r.height),o=t.getImageData(0,0,r.width,r.height).data}this._rsControler.enqueue(o)}),close:()=>{this._rsControler.close()}})}static get ctx2d(){if(!this._ctx2d){if(!o)throw Error("Failed to get ImageToPixels.ctx2d, not in browser.");let e=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});if(!e)throw Error("Failed to get ImageToPixels.ctx2d, getContext('2d') return null.");this._ctx2d=e}return this._ctx2d}}class p{constructor(e){this.maxColors=e,this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>{this._rsControler.enqueue(this._boxesToQuantizedColors(this._colorsToBoxes(e)))},close:()=>{this._rsControler.close()}})}static createSorter(e){let t=e[0],r=e[1],i=e[2];return(e,n)=>e.lab[t]-n.lab[t]||e.lab[r]-n.lab[r]||e.lab[i]-n.lab[i]}_colorsToBoxes(e){let t={start:0,end:e.length-1,sorted:null,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}},r=[t],i=1,n=(e,t,r)=>e>=t?t>=r?"lab":e>=r?"lba":"bla":e>=r?"alb":t>=r?"abl":"bal",o=t=>{let{start:r,end:i}=t;t.count=i-r+1,t.weight=0;let o={l:0,a:0,b:0};for(let n=r;n<=i;n++){let r=e[n];o.l+=r.lab.l*r.count,o.a+=r.lab.a*r.count,o.b+=r.lab.b*r.count,t.weight+=r.count}t.avg.l=o.l/t.weight,t.avg.a=o.a/t.weight,t.avg.b=o.b/t.weight;let l={l:0,a:0,b:0};for(let n=r;n<=i;n++){let r=e[n];l.l+=T(r.lab.l-t.avg.l,2)*r.count,l.a+=T(r.lab.a-t.avg.a,2)*r.count,l.b+=T(r.lab.b-t.avg.b,2)*r.count}t.sort=n(l.l,l.a,l.b),t.score=Math.max(l.l,l.a,l.b)},l=(e,t)=>{let n={start:t+1,end:e.end,sorted:e.sorted,count:0,score:0,weight:0,sort:"lab",avg:{l:0,a:0,b:0}};o(n),e.end-=n.count,o(e),r.push(n),i++},a=()=>{let e=-1,t=-1;if(i===this.maxColors)return -1;for(let n=0;n<i;n++){let i=r[n];i.count>=2&&i.score>t&&(e=n,t=i.score)}return e};for(o(t);t&&t.count>1;){let{start:i,end:n,sort:o,sorted:s}=t;if(o!==s){let r=e.slice(i,n+1).sort(p.createSorter(o));for(let t=r.length,n=0;n<t;n++)e[i+n]=r[n];t.sorted=o}let h=t.weight+1>>1,c=i,d=0;for(;c<n-1&&!((d+=e[c].count)>h);c++);l(t,c);let u=a();t=u>=0?r[u]:null}return r}_boxesToQuantizedColors(e){let t=e.reduce((e,t)=>e+t.weight,0);return e.map(e=>{let{r:r,g:i,b:n}=function(e){let t=e.l+h(25974*e.a,65535)+h(14143*e.b,65535),r=e.l+h(-6918*e.a,65535)+h(-4185*e.b,65535),i=e.l+h(-5864*e.a,65535)+h(-84638*e.b,65535),n=T(t,3)/0xfffe0001,o=T(r,3)/0xfffe0001,l=T(i,3)/0xfffe0001;return{r:~~f((267169*n+-216771*o+15137*l+32767.5)/65535),g:~~f((-83127*n+171030*o+-22368*l+32767.5)/65535),b:~~f((-275*n+-46099*o+111909*l+32767.5)/65535)}}(e.avg);return{rgbInt:d(r,i,n),rgb:{r:r,g:i,b:n},hex:`#${r.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`,lab:e.avg,count:e.weight,percentage:e.weight/t}}).sort((e,t)=>e.rgbInt-t.rgbInt)}}class b{constructor(e,t,r){this.statsMode=e,this.premultipliedAlpha=t,this.tint=r,this._colors=[],this._cache=new Map,this.readable=new ReadableStream({start:e=>this._rsControler=e}),this.writable=new WritableStream({write:e=>{for(let t=e.length,r=0;r<t;r+=4){let t=e[r],i=e[r+1],n=e[r+2],o=e[r+3];if("diff"===this.statsMode&&this._previousPixels&&t===this._previousPixels[r]&&i===this._previousPixels[r+1]&&n===this._previousPixels[r+2]&&o===this._previousPixels[r+3])continue;({r:t,g:i,b:n}=c(t,i,n,o,this.premultipliedAlpha,this.tint));let l=d(t,i,n),a={rgbInt:l,lab:u(t,i,n),count:1},s=l%32768,h=this._cache.get(s);h||this._cache.set(s,h=new Map);let f=h.get(l);if(void 0!==f){this._colors[f].count++;continue}f=this._colors.push(a)-1,h.set(l,f)}"diff"===this.statsMode&&(this._previousPixels=e)},close:()=>{this._rsControler.enqueue(this._colors.slice()),this._rsControler.close(),this._colors.length=0,this._cache.clear(),this._previousPixels=void 0}})}}class w{constructor(e=[],t=!1,r=[255,255,255]){this._premultipliedAlpha=t,this._tint=r,this._cache=new Map,this._colorMap=[],e.length&&this.setup(e)}setup(e){e=e.sort((e,t)=>e.rgbInt-t.rgbInt),this._cache.clear();let t=[],r=new Map;for(let t=-1,i=e.length,n=0;n<i;n++){let{rgbInt:i}=e[n];if(i===t){r.set(n,!0);continue}t=i}(function i(n){let{index:o,longest:l,longestIndex:a}=function(t){let i={min:[65535,65535,65535],max:[-65535,-65535,-65535]},n=[];for(let o=e.length,l=0;l<o;l++){let{lab:o}=e[l];r.has(l)||o.l<t.min[0]||o.a<t.min[1]||o.b<t.min[2]||o.l>t.max[0]||o.a>t.max[1]||o.b>t.max[2]||(o.l<i.min[0]&&(i.min[0]=o.l),o.a<i.min[1]&&(i.min[1]=o.a),o.b<i.min[2]&&(i.min[2]=o.b),o.l>i.max[0]&&(i.max[0]=o.l),o.a>i.max[1]&&(i.max[1]=o.a),o.b>i.max[2]&&(i.max[2]=o.b),n.push({lab:o,index:l}))}let o="l",l=0;if(!n.length)return{index:-1,longest:o,longestIndex:l};let a=i.max[0]-i.min[0],s=i.max[1]-i.min[1],h=i.max[2]-i.min[2];return h>=a&&h>=s&&(o="b",l=2),s>=a&&s>=h&&(o="a",l=1),a>=s&&a>=h&&(o="l",l=0),{index:n.sort((e,t)=>e.lab[o]-t.lab[o])[n.length>>1].index,longest:o,longestIndex:l}}(n);if(o<0)return -1;r.set(o,!0);let{lab:s}=e[o],h={left:0,right:0,longest:l,lab:s,index:o},c=t.push(h)-1,d={max:[...n.max],min:[...n.min]},u={max:[...n.max],min:[...n.min]};d.max[a]=s[l],u.min[a]=Math.min(s[l]+1,65535);let f=i(d),g=-1;return u.min[a]<=u.max[a]&&(g=i(u)),h.left=f,h.right=g,c})({min:[-65535,-65535,-65535],max:[65535,65535,65535]}),this._colorMap=t}_colormapNearestNode(e,t,r){let i,n;let{left:o,right:l,longest:a,lab:s,index:h}=this._colorMap[e],c=Math.min(T(t.l-s.l,2)+T(t.a-s.a,2)+T(t.b-s.b,2),0xfffffffe);if(c<r.dist&&(r.index=h,r.dist=c),-1!==o||-1!==l){let e=t[a]-s[a];e<=0?(i=o,n=l):(i=l,n=o),-1!==i&&this._colormapNearestNode(i,t,r),-1!==n&&T(e,2)<r.dist&&this._colormapNearestNode(n,t,r)}}findNearestIndex(e,t,r,i=255){({r:e,g:t,b:r}=c(e,t,r,i,this._premultipliedAlpha,this._tint));let n=d(e,t,r),o=n%32768,l=this._cache.get(o);l||this._cache.set(o,l=new Map);let a=l.get(n);if(void 0!==a)return a;let s={dist:Number.MAX_SAFE_INTEGER,index:-1};return this._colormapNearestNode(0,u(e,t,r),s),a=s.index,l.set(n,a),a}}class m{constructor(e={}){this.colors=[],this.config=this._resolveOptions(e),this._stream=this._createStream()}_resolveOptions(e){let{maxColors:t=256,statsMode:r="full",algorithm:i="median-cut",premultipliedAlpha:n=!1,tint:o=[255,255,255],samples:l=[]}=e;return{maxColors:t,statsMode:r,algorithm:i,premultipliedAlpha:n,tint:o,samples:l}}_createStream(){let e;return this.config.algorithm,e=new p(this.config.maxColors),new ReadableStream({start:e=>{this._streamControler=e,this.config.samples.forEach(t=>e.enqueue(t))}}).pipeThrough(new g).pipeThrough(new b(this.config.statsMode,this.config.premultipliedAlpha,this.config.tint)).pipeThrough(e)}addSample(e){this._streamControler.enqueue(e)}generate(){return new Promise(e=>{this._streamControler.close(),this._stream.pipeTo(new WritableStream({write:t=>{this.colors=t,this.finder=new w(t,this.config.premultipliedAlpha,this.config.tint),this._stream=this._createStream(),e(t)}}))})}match(e){var t;let r;if("number"==typeof e)r=[e>>24&255,e>>16&255,e>>8&255,255&e];else if("string"==typeof e){let t=e.replace(/^#/,"");r=[`${t[0]}${t[1]}`,`${t[2]}${t[3]}`,`${t[4]}${t[5]}`].map(e=>parseInt(e,16))}else if(Array.isArray(e))r=e;else throw TypeError("Unsupported color format");let i=null==(t=this.finder)?void 0:t.findNearestIndex(r[0],r[1],r[2],r[3]);if(void 0===i||i<0)return;let n=this.colors[i];if(n)return{color:n,index:i}}toColors(){return this.colors.slice()}toHexColors(){return this.colors.map(e=>e.hex)}toRgbColors(){return this.colors.map(e=>e.rgb)}toRgbIntColors(){return this.colors.map(e=>e.rgbInt)}toLabColors(){return this.colors.map(e=>e.lab)}toUint8Array(e=4*this.colors.length){var t,r;let i;let n=new Uint8ClampedArray(e);for(let o=0;o<e;o++){let e=4*o,l=null!=(t=null==(r=this.colors[o])?void 0:r.rgb)?t:i;l&&(n[e]=l.r,n[e+1]=l.g,n[e+2]=l.b,n[e+3]=255,i=l)}return n}clear(){this.colors.length=0,this._stream=this._createStream()}}let _=class e{constructor(e=!0){this.isDebug=e}time(t){this.isDebug&&console.time(`${e.prefix} ${t}`)}timeEnd(t){this.isDebug&&console.timeEnd(`${e.prefix} ${t}`)}debug(...t){this.isDebug&&console.debug(e.prefix,...t)}warn(...t){this.isDebug&&console.warn(e.prefix,...t)}};x(_,"prefix","[modern-gif]");class y{constructor(e){x(this,"_rsControler"),x(this,"_frames",[]),x(this,"readable",new ReadableStream({start:e=>this._rsControler=e})),x(this,"writable",new WritableStream({write:e=>{this._frames.push(e)},close:()=>{let e;let t=this._config.backgroundColorIndex;this._frames.forEach((r,i)=>{var n,o;let{width:l=1,height:a=1,data:s}=r,h=r.transparent||null==(o=null==(n=this._frames[i+1])?void 0:n.transparent)||o,c=0,d=0,u=l-1,f=a-1,g;if(h){for(;d<f;){let e=!0;for(let r=0;r<l;r++)if(s[l*d+r]!==t){e=!1;break}if(!e)break;d++}for(;f>d;){let e=!0;for(let r=0;r<l;r++)if(s[l*f+r]!==t){e=!1;break}if(!e)break;f--}for(;c<u;){let e=!0;for(let r=d;r<f;r++)if(s[l*r+c]!==t){e=!1;break}if(!e)break;c++}for(;u>c;){let e=!0;for(let r=d;r<f;r++)if(s[l*r+u]!==t){e=!1;break}if(!e)break;u--}}else{if(e){for(;d<f;){let t=!0;for(let r=0;r<l;r++){let i=l*d+r;if(s[i]!==e[i]){t=!1;break}}if(!t)break;d++}for(;f>d;){let t=!0;for(let r=0;r<l;r++){let i=l*f+r;if(s[i]!==e[i]){t=!1;break}}if(!t)break;f--}if(d===f)c=u;else{for(;c<u;){let t=!0;for(let r=d;r<=f;r++){let i=r*l+c;if(s[i]!==e[i]){t=!1;break}}if(!t)break;c++}for(;u>c;){let t=!0;for(let r=d;r<=f;r++){let i=r*l+u;if(s[i]!==e[i]){t=!1;break}}if(!t)break;u--}}}g=e,e=s}let p=u+1-c,b=f+1-d,w=new Uint8ClampedArray(p*b);for(let e=0;e<b;e++)for(let r=0;r<p;r++){let i=e*p+r,n=(d+e)*l+(c+r);if(!h&&g&&s[n]===g[n]){w[i]=t;continue}w[i]=s[n]}this._rsControler.enqueue(R(M({},r),{left:c,top:d,width:p,height:b,disposal:h?2:1,data:w,graphicControl:R(M({},r.graphicControl),{transparent:!0,transparentIndex:t})}))}),this._rsControler.close()}})),this._config=e}}class C{constructor(e=4096){x(this,"_chunks"),x(this,"_chunkIndex",0),x(this,"_chunkOffset",0),this._chunkByteLength=e,this._chunks=[this._createChunk()]}get cursor(){return[this._chunkIndex,this._chunkOffset]}_createChunk(){return new DataView(new ArrayBuffer(this._chunkByteLength))}writeByte(e,t){t?this._chunks[t[0]].setUint8(t[1],e):(this._chunkOffset>=this._chunkByteLength&&(this._chunks[++this._chunkIndex]=this._createChunk(),this._chunkOffset=0),this._chunks[this._chunkIndex].setUint8(this._chunkOffset++,e))}writeBytes(e){e.forEach(e=>this.writeByte(e))}writeString(e){e.split("").forEach(e=>{this.writeByte(e.charCodeAt(0))})}writeUnsigned(e){this.writeBytes([255&e,e>>8&255])}calculateDistance(e){return this._chunkIndex*this._chunkByteLength+this._chunkOffset-(e[0]*this._chunkByteLength+e[1])}toUint8Array(){this._chunks[this._chunkIndex]=new DataView(this._chunks[this._chunkIndex].buffer.slice(0,this._chunkOffset));let e=new Uint8Array(this._chunks.reduce((e,t)=>e+t.byteLength,0)),t=0;return this._chunks.forEach(r=>{e.set(new Uint8Array(r.buffer),t),t+=r.byteLength}),this._chunks=[this._createChunk()],this._chunkIndex=0,this._chunkOffset=0,e}}class k{constructor(e){x(this,"_rsControler"),x(this,"_frames",[]),x(this,"readable",new ReadableStream({start:e=>this._rsControler=e})),x(this,"writable",new WritableStream({write:e=>{this._frames.push(e)},close:()=>{let e=this._encodeHeader(),t=r(this._frames),i=new Uint8Array(e.length+t.byteLength+1);i.set(e),i.set(t,e.byteLength),i[i.length-1]=59,this._rsControler.enqueue(i),this._rsControler.close(),this._frames.length=0}})),this._config=e}_encodeHeader(){var e,t,r;let i=M({version:"89a",looped:!0,loopCount:0,pixelAspectRatio:0},this._config);if(i.width<=0||i.width>65535)throw Error("Width invalid.");if(i.height<=0||i.height>65535)throw Error("Height invalid.");let n=0;if(null!=(e=i.colorTable)&&e.length){let e=i.colorTable.length;if(e<2||e>256||e&e-1)throw Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;e>>=1;)++n;if(e=1<<n,i.colorTableSize=--n,i.backgroundColorIndex>=e)throw Error("Background index out of range.");if(0===i.backgroundColorIndex)throw Error("Background index explicitly passed as 0.")}let o=new C;return o.writeString("GIF"),o.writeString(i.version),o.writeUnsigned(i.width),o.writeUnsigned(i.height),o.writeByte(Number.parseInt(`${i.colorTableSize?1:0}1110${i.colorTableSize.toString(2).padStart(3,"0")}`,2)),o.writeByte(i.backgroundColorIndex),o.writeByte(i.pixelAspectRatio),o.writeBytes(null!=(r=null==(t=i.colorTable)?void 0:t.flat())?r:[]),i.looped&&(o.writeByte(33),o.writeByte(255),o.writeByte(11),o.writeString("NETSCAPE2.0"),o.writeByte(3),o.writeByte(1),o.writeUnsigned(i.loopCount),o.writeByte(0)),o.toUint8Array()}}class B{constructor(e){x(this,"_rsControler"),x(this,"readable",new ReadableStream({start:e=>this._rsControler=e})),x(this,"writable",new WritableStream({write:e=>{var t,r,i;let n=new C,{left:o=0,top:l=0,width:a=0,height:s=0,delay:h=100,colorTable:c}=e,{disposal:d=0}=e,u=null==(t=e.graphicControl)?void 0:t.transparent,f=null!=(i=null==(r=e.graphicControl)?void 0:r.transparentIndex)?i:255;if(o<0||o>65535)throw Error("Left invalid.");if(l<0||l>65535)throw Error("Top invalid.");if(a<=0||a>65535)throw Error("Width invalid.");if(s<=0||s>65535)throw Error("Height invalid.");let g=8,p=c?c.length:0;if(p){if(p<2||p>256||p&p-1)throw Error("Invalid color table length, must be power of 2 and 2 .. 256.");for(;p>>=1;)++g}n.writeByte(33),n.writeByte(249),n.writeByte(4),u?d||(d=2):f=0,n.writeByte(Number.parseInt(`000${Number(7&d).toString(2).padStart(3,"0")}0${u?1:0}`,2)),n.writeUnsigned(h/10),n.writeByte(f),n.writeByte(0),n.writeByte(44),n.writeUnsigned(o),n.writeUnsigned(l),n.writeUnsigned(a),n.writeUnsigned(s),null!=c&&c.length?(n.writeByte(Number.parseInt(`10000${(g-1).toString(2).padStart(3,"0")}`,2)),n.writeBytes(c.flat())):n.writeByte(0),function(e,t,r){r.writeByte(e);let i=r.cursor;r.writeByte(0);let n=1<<e,o=n-1,l=n+1,a=l+1,s=e+1,h=0,c=0;function d(e){for(;h>=e;)r.writeByte(255&c),c>>=8,h-=8,256===r.calculateDistance(i)&&(r.writeByte(255,i),i=r.cursor,r.writeByte(0))}function u(e){c|=e<<h,h+=s,d(8)}let f=t[0]&o,g={},p,b,w;u(n);for(let d=t.length,m=1;m<d;++m)if(void 0===(b=g[p=f<<8|(w=t[m]&o)])){for(c|=f<<h,h+=s;h>=8;)r.writeByte(255&c),c>>=8,h-=8,256===r.calculateDistance(i)&&(r.writeByte(255,i),i=r.cursor,r.writeByte(0));4096===a?(u(n),a=l+1,s=e+1,g={}):(a>=1<<s&&++s,g[p]=a++),f=w}else f=b;u(f),u(l),d(1),1===r.calculateDistance(i)?r.writeByte(0,i):(r.writeByte(r.calculateDistance(i)-1,i),r.writeByte(0))}(g,e.data,n),this._rsControler.enqueue(n.toUint8Array())},close:()=>this._rsControler.close()})),this._config=e}}class v{constructor(e,t){x(this,"_rsControler"),x(this,"_finder"),x(this,"readable",new ReadableStream({start:e=>this._rsControler=e})),x(this,"writable",new WritableStream({write:e=>{let t=this._config.backgroundColorIndex,r=e.data,i=!1,n=new Uint8ClampedArray(r.length/4);for(let e=r.length,o=0;o<e;o+=4)0===r[o+3]?(n[o/4]=t,i=!0):n[o/4]=this._finder.findNearestIndex(r[o],r[o+1],r[o+2],r[o+3]);this._rsControler.enqueue(R(M({},e),{data:n,transparent:i}))},close:()=>{this._rsControler.close()}})),this._config=e,this._finder=new w(t,e.premultipliedAlpha,e.tint)}}class S{constructor(e){var t;x(this,"_logger"),x(this,"_palette"),x(this,"_config"),x(this,"_encodingFrames",[]),x(this,"_encodeUUID",0),x(this,"_worker"),this._logger=new _(!!e.debug),this._config=this._resolveOptions(e),this._palette=new m({maxColors:this._config.maxColors,premultipliedAlpha:this._config.premultipliedAlpha,tint:this._config.tint}),this._config.workerUrl?(this._worker=function(e){let t,r;let i=new Map,{workerUrl:n}=e,{workerNumber:o=1}=e,l=[...Array.from({length:n?o:0})].map(()=>{try{let e=new Worker(n);return e.onmessage=a,e}catch(e){return console.warn(e),null}}).filter(Boolean);function a(e){var t;let{id:r,data:n}=e.data;null==(t=i.get(r))||t(n),i.delete(r)}o=l.length;let s=(t=0,e=>l[(null!=e?e:t++)%o]);return{call:(r=0,(e,t,n,o)=>new Promise(l=>{let a=s(o);if(!a)return l(void 0);i.set(r,l),a.postMessage({id:r++,type:e,data:t},{transfer:n})}))}}({workerUrl:this._config.workerUrl}),this._worker.call("encoder:init",e)):null==(t=this._config.frames)||t.forEach(e=>this.encode(e))}_resolveOptions(e){["width","height"].forEach(t=>{void 0!==e[t]&&Math.floor(e[t])!==e[t]&&(console.warn(`${t} cannot be a floating point number`),e[t]=Math.floor(e[t]))});let{colorTableSize:t=256,backgroundColorIndex:r=t-1,maxColors:i=t-1,premultipliedAlpha:n=!1,tint:o=[255,255,255]}=e;return R(M({},e),{colorTableSize:t,backgroundColorIndex:r,maxColors:i,premultipliedAlpha:n,tint:o})}encode(e){return Z(this,null,function*(){if(this._worker){let t;return ArrayBuffer.isView(e.data)?t=[e.data.buffer]:e.data instanceof ArrayBuffer&&(t=[e.data]),this._worker.call("encoder:encode",e,t)}let t=this._encodeUUID;this._encodeUUID++;let{width:r=this._config.width,height:n=this._config.height}=e,{data:o}=e;try{var l;this._logger.time(`palette:sample-${t}`),o="string"==typeof o?yield(l=o,new Promise((e,t)=>{let r=function(e){let t=new Image;return t.decoding="sync",t.loading="eager",t.crossOrigin="anonymous",t.src=e,t}(l);r.onload=()=>e(r),r.onerror=t})):o,o=i(o,"uint8ClampedArray",{width:r,height:n}),this._encodingFrames.push(R(M({},e),{width:r,height:n,data:o})),this._palette.addSample(o)}finally{this._logger.timeEnd(`palette:sample-${t}`)}})}flush(e){return Z(this,null,function*(){if(this._worker)return this._worker.call("encoder:flush",e);this._logger.time("palette:generate");let t=yield this._palette.generate();this._logger.timeEnd("palette:generate");let r=t.map(e=>[e.rgb.r,e.rgb.g,e.rgb.b]);for(;r.length<this._config.colorTableSize;)r.push([0,0,0]);this._logger.debug("palette:maxColors",this._config.maxColors),this._logger.isDebug&&console.debug(t.map(()=>"%c ").join(""),...t.map(e=>`margin: 1px; background: ${e.hex}`)),this._logger.time("encode");let i=yield new Promise(e=>{new ReadableStream({start:e=>{this._encodingFrames.forEach(t=>{e.enqueue(t)}),e.close()}}).pipeThrough(new v(this._config,t)).pipeThrough(new y(this._config)).pipeThrough(new B(this._config)).pipeThrough(new k(R(M({},this._config),{colorTable:r}))).pipeTo(new WritableStream({write:t=>e(t)}))});return(this._logger.timeEnd("encode"),this._encodingFrames=[],this._encodeUUID=0,"blob"===e)?new Blob([i.buffer],{type:"image/gif"}):i.buffer})}}self.onmessage=o=>Z(this,null,function*(){let{id:l,type:a,data:s}=o.data;switch(a){case"encoder:init":return e=new S(R(M({},s),{workerUrl:void 0})),self.postMessage({id:l,type:a,data:!0});case"encoder:encode":return self.postMessage({id:l,type:a,data:yield null==e?void 0:e.encode(s)});case"encoder:flush":return self.postMessage({id:l,type:a,data:yield null==e?void 0:e.flush(s)});case"frames:decode":{let e=function(e,o){let l=i(e,"uint8Array"),{gif:a=function(e){let r={},i=new n(e),o=()=>({index:0,delay:100,disposal:0}),l=i.readString(3),a=i.readString(3);if("GIF"!==l||!t.includes(a))throw Error("This is not a 87a/89a GIF data.");r.version=a,r.width=i.readUnsigned(),r.height=i.readUnsigned();let s=i.readBits();r.globalColorTable=!!s[0],r.colorResoluTion=Number.parseInt(s.slice(1,4).join(""),2)+1,r.colorTableSorted=!!s[4];let h=Number.parseInt(s.slice(5,8).join(""),2);r.colorTableSize=T(2,h+1),r.backgroundColorIndex=i.readByte(),r.pixelAspectRatio=i.readByte(),r.globalColorTable&&(r.colorTableSize?r.colorTable=i.readColorTable(r.colorTableSize):i.readSubBlock()),r.frames=[];let c=o(),d=[],u=[];for(;;){let e=i.readByte();if(d.push(e),44===e){c.left=i.readUnsigned(),c.top=i.readUnsigned(),c.width=i.readUnsigned(),c.height=i.readUnsigned();let e=i.readBits();c.localColorTable=!!e[0],c.interlaced=!!e[1],c.colorTableSorted=!!e[2],c.reserved=Number.parseInt(e.slice(3,5).join(""),2);let t=Number.parseInt(e.slice(5,8).join(""),2);for(c.colorTableSize=T(2,t+1),c.localColorTable&&(c.colorTable=i.readColorTable(c.colorTableSize)),c.lzwMinCodeSize=i.readByte(),c.dataPositions=[];;){let e=i.readByte();if(0===e)break;let t=i.offset;c.dataPositions.push([t,e]),i.offset=t+e}r.frames.push(c),(c=o()).index=r.frames.length;continue}if(33===e){let e=i.readByte();if(u.push(e),255===e){if(11!==i.readByte())continue;let e={identifier:i.readString(8),code:i.readString(3),data:[]};"NETSCAPE2.0"==`${e.identifier}${e.code}`&&3===i.readByte()&&(r.looped=!!i.readByte(),r.loopCount=i.readUnsigned()),e.data=i.readSubBlock(),c.application=e;continue}if(254===e){c.comment=i.readSubBlock().map(e=>String.fromCharCode(e)).join("");continue}if(249===e){if(4!==i.readByte())continue;let e=i.readBits(),t={reserved:Number.parseInt(e.slice(0,3).join(""),2),disposal:Number.parseInt(e.slice(3,6).join(""),2),userInput:!!e[6],transparent:!!e[7],delayTime:i.readUnsigned(),transparentIndex:i.readByte()};i.readSubBlock(),c.graphicControl=t,c.disposal=t.disposal,c.delay=10*(t.delayTime||10);continue}if(1===e){if(1!==i.readByte())continue;c.plainText={left:i.readUnsigned(),top:i.readUnsigned(),width:i.readUnsigned(),height:i.readUnsigned(),cellWidth:i.readByte(),cellHeight:i.readByte(),colorIndex:i.readByte(),backgroundColorIndex:i.readByte(),data:i.readSubBlock()};continue}console.warn(`Unknown extension block: 0x${e.toString(16)}`,d.slice(0,d.length-1).map(e=>`0x${e.toString(16)}`),u.slice(0,u.length-1).map(e=>`0x${e.toString(16)}`));continue}if(59===e)break;console.warn(`Unknown block: 0x${e.toString(16)}`,d.slice(0,d.length-1).map(e=>`0x${e.toString(16)}`),u.slice(0,u.length-1).map(e=>`0x${e.toString(16)}`))}return r}(e),range:s}={},{width:h,height:c,colorTable:d,frames:u}=a,f=s?u.slice(s[0],s[1]+1):u,g=f.some(e=>3===e.disposal),p=new Uint8ClampedArray(h*c*4),b,w=p.slice();return f.map(e=>{var t;let{left:i,top:n,width:o,height:a,interlaced:s,localColorTable:u,colorTable:f,lzwMinCodeSize:m,dataPositions:_,graphicControl:y,delay:C,disposal:k}=e,B=null==b?void 0:b.disposal,v=n+a,{transparent:S,transparentIndex:I}=null!=y?y:{},A=u?f:d,U=S?I:-1,E=function(e,t,r){let i,n,o,l,a,s,h,c,d,u,f,g,p;let b=Array.from({length:r}),w=Array.from({length:4096}),m=Array.from({length:4096}),_=Array.from({length:4097}),y=1<<e,C=y+1;for(i=y+2,a=-1,n=(1<<(o=e+1))-1,s=0;s<y;s++)w[s]=0,m[s]=s;for(c=d=u=f=g=p=0,h=0;h<r;){if(0===f){if(d<o){c+=t[p]<<d,d+=8,p++;continue}if(s=c&n,c>>=o,d-=o,s>i||s===C)break;if(s===y){n=(1<<(o=e+1))-1,i=y+2,a=-1;continue}if(-1===a){_[f++]=m[s],a=s,u=s;continue}for(l=s,s===i&&(_[f++]=u,s=a);s>y;)_[f++]=m[s],s=w[s];u=255&m[s],_[f++]=u,i<4096&&(w[i]=a,m[i]=u,!(++i&n)&&i<4096&&(o++,n+=i)),a=l}f--,b[g++]=_[f],h++}for(h=g;h<r;h++)b[h]=0;return b}(m,r(_.map(([e,t])=>l.subarray(e,e+t))),o*a);if(s&&(E=function(e,t){let r=Array.from({length:e.length}),i=e.length/t,n=[0,4,2,1],o=[8,8,4,2],l=0;for(let a=0;a<4;a++)for(let s=n[a];s<i;s+=o[a])r.splice.apply(r,[s*t,t].concat(e.slice(l*t,(l+1)*t))),l++;return r}(E,o)),3===B)p=w.slice();else if(2===B){let{left:e,top:t,width:r,height:i}=b,n=t+i;for(let i=t;i<n;i++){let t=i*h+e;for(let e=0;e<r;e++){let r=(t+e)*4;p[r]=p[r+1]=p[r+2]=p[r+3]=0}}}for(let e=n;e<v;e++){let r=e*h+i,l=(e-n)*o;for(let e=0;e<o;e++){let i=E[l+e],n=(r+e)*4;if(i!==U){let[e,r,o]=null!=(t=null==A?void 0:A[i])?t:[0,0,0];p[n]=e,p[n+1]=r,p[n+2]=o,p[n+3]=255}}}return g&&1!==k&&3!==k&&(w=p.slice()),b=e,{width:h,height:c,delay:C,data:p.slice()}})}(s);return self.postMessage({id:l,type:a,data:e},e.map(e=>e.data.buffer))}}})}();